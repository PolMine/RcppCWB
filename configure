#!/bin/bash

case $(uname -s) in
  Darwin)
    sed -i -e "s/PLATFORM=.*/PLATFORM=darwin-64/" ./src/cwb/config.mk;;
  Linux)
    ARCH=`lscpu | head -n 1 | grep -oP '\w+$'`
    case "$ARCH" in 
      x86_64)
        sed -i -e "s/PLATFORM=.*/PLATFORM=linux-64/" ./src/cwb/config.mk;;
      i386) 
        sed -i -e "s/PLATFORM=.*/PLATFORM=linux/" ./src/cwb/config.mk;;
      arm)
        sed -i -e "s/PLATFORM=.*/PLATFORM=unix/" ./src/cwb/config.mk;;
    esac;;
  SunOS)
    CPU_INFO=`psrinfo -pv | sed -n '2p'`
    case $CPU_INFO in
      x86)
        sed -i -e "s/PLATFORM=.*/PLATFORM=unix/" ./src/cwb/config.mk;;
      SPARK)
        sed -i -e "s/PLATFORM=.*/PLATFORM=solaris/" ./src/cwb/config.mk;;
    esac;;
esac



# create Makevars

PKG_DIR=`pwd`/src/cwb
echo "PKG_CPPFLAGS=-I../inst/include/cwb" > ./src/Makevars
echo -e "PKG_LIBS=-L./src/cwb/cl -lcl\n" >> ./src/Makevars
echo -e "all: cl\n" >>./src/Makevars
echo "cl: depend" >> ./src/Makevars
echo -e "\tR_PACKAGE_SOURCE="$PKG_DIR" \$(MAKE) -C cwb cl\n" >> ./src/Makevars
echo "depend: clean" >> ./src/Makevars
echo -e "\tR_PACKAGE_SOURCE="$PKG_DIR" \$(MAKE) -C cwb depend\n" >> ./src/Makevars
echo "clean:" >> ./src/Makevars
echo -e "\tR_PACKAGE_SOURCE="$PKG_DIR" \$(MAKE) -C cwb clean\n" >> ./src/Makevars

cat ./src/Makevars

# Call the setpaths.R script to set paths (template in package ctk)

${R_HOME}/bin/Rscript ./tools/setpaths.R --args "$R_PACKAGE_DIR"

