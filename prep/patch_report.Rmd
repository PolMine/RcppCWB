---
title: "Patching the CWB: Diff report"
author: "Andreas Blaette"
date: "7/9/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

## About this document

We assume that the branch 'r1069' has been created with a clean CWB v3.4.14 and that patches have been applied using the patch.R script. The purpose of this document is to identify the remaining differences to the latest commit of the dev branch of RcppCWB.


## Apply patches

```{r}
library(git2r)
library(fs)
repodir <- path.expand("~/Lab/github/RcppCWB")
```

Patches will be applied to the CWB code on the r1069 branch but will be compared against dev branch.

```{r}
checkout(repodir, branch = "dev")
last_devbranch_commit <- last_commit(repo = repodir)
```

We need a temporary copy of (the most recent version of) patch.R. It may not be available once we are on the r1069 branch.

```{r}
patchfile <- path(repodir, "prep", "patch.R")
tmp_patchfile <- path(tempdir(), "path.R")
file_copy(path = patchfile, new_path = tmp_patchfile, overwrite = TRUE)
```

Checkout the r1069 branch and apply patches.

```{r}
checkout(repodir, branch = "r1069")
source(tmp_patchfile)
```

Add and commit changes so that we can prepare diffs.

```{r}
git2r::add(repo = repodir, path = "src/cwb/*")
```


## Inspect diffs

#### cl directory
  
```{r}
setwd("~/Lab/github/RcppCWB/src/cwb/cl")
git_cmd <- sprintf(
  "git diff HEAD..%s . %s", last_devbranch_commit[["sha"]],
  "':!*endian.h'"
)
result <- system(git_cmd, intern = TRUE)
cat(paste(result, collapse = "\n"))
```
  Finding: Modifications of the Makefile, nothing else

#### cqp directory

```{r}  
setwd("~/Lab/github/RcppCWB/src/cwb/cqp")
git_cmd <- sprintf(
  "git diff HEAD..%s . %s", last_devbranch_commit[["sha"]],
  "':!*_options.h' ':!*parser.tab.c' ':!*parser.tab.h'"
)
result <- system(git_cmd, intern = TRUE)
cat(paste(result, collapse = "\n"))
```


#### CQi directory

```{r}
setwd("~/Lab/github/RcppCWB/src/cwb/CQi")
git_cmd <- sprintf(
  "git diff HEAD..%s .", last_devbranch_commit[["sha"]]
)
result <- system(git_cmd, intern = TRUE)
cat(paste(result, collapse = "\n"))
```


#### utils directory
  
```{r}
setwd("~/Lab/github/RcppCWB/src/cwb/utils")
git_cmd <- sprintf(
  "git diff HEAD..%s .", last_devbranch_commit[["sha"]]
)
result <- system(git_cmd, intern = TRUE)
cat(paste(result, collapse = "\n"))
```


### Cleaning up

```{r}
git2r::reset(repodir, reset_type = "hard")
checkout(repo = repodir, branch = "dev")
```
